# Screeem Web Application

Modern React frontend for the Screeem social media scheduling platform, built with Vite, TanStack Router, and event sourcing.

## Tech Stack

- **Build Tool**: Vite 6
- **Framework**: React 18
- **Routing**: TanStack Router (file-based)
- **Data Fetching**: TanStack Query
- **State Management**: Zustand
- **Authentication**: Supabase Auth
- **Styling**: Tailwind CSS
- **Real-time**: Server-Sent Events (SSE)

## Features

### ✅ Authentication
- Magic link login via Supabase
- Protected routes with automatic redirects
- Session persistence

### ✅ Organization Management
- Create and manage multiple organizations
- Team member management
- Role-based access control (owner, admin, member)
- Email invitations with 7-day expiry

### ✅ Post Scheduling
- Schedule posts to Twitter/X
- Real-time updates via SSE
- Optimistic UI updates
- Local event sourcing for offline-first experience
- 280 character limit validation
- Post preview

### ✅ Real-time Event Streaming
- SSE connection to backend for live updates
- Automatic reconnection with exponential backoff
- Event-sourced post timeline
- Optimistic updates with rollback support

## Architecture

### Event Sourcing

Posts are managed using event sourcing:

```typescript
// Events flow through the system:
User Action → Command → Event → Event Store → SSE → Frontend Store → UI Update

// Example: Scheduling a post
1. User submits form
2. Create optimistic event → Update UI immediately
3. Send command to backend
4. Backend validates and persists event
5. SSE pushes confirmed event to all clients
6. Frontend reconciles optimistic vs confirmed event
```

### Local Event Store (Zustand)

The frontend maintains a local projection of post state:

```typescript
// Store structure
{
  events: StoredEvent[]           // Event log
  posts: Map<string, Post>        // Current post state
  optimisticEvents: Map<...>      // Pending confirmations
}

// Apply events to rebuild state
PostScheduled → Create post
PostUpdated → Update content/schedule
PostPublished → Mark as published with tweet ID
PostFailed → Mark as failed with error
PostCancelled → Mark as cancelled
```

### File Structure

```
src/
├── routes/                         # TanStack Router routes (auto-generated)
│   ├── __root.tsx                 # Root layout
│   ├── index.tsx                  # Landing page
│   ├── auth/
│   │   ├── login.tsx             # Magic link request
│   │   └── callback.tsx          # Auth callback handler
│   └── app/                      # Protected app routes
│       ├── _layout.tsx           # App layout with nav
│       ├── dashboard.tsx         # Main dashboard
│       ├── posts/
│       │   ├── index.tsx         # Posts list
│       │   └── new.tsx           # Schedule new post
│       └── settings/
│           └── organization.tsx  # Org settings
├── lib/
│   ├── api/
│   │   ├── client.ts            # API client with auth
│   │   └── hooks.ts             # TanStack Query hooks
│   ├── auth/
│   │   └── context.tsx          # Auth provider
│   ├── event-store/
│   │   └── store.ts             # Zustand event store
│   ├── sse/
│   │   └── client.ts            # SSE client
│   ├── supabase.ts              # Supabase client
│   └── utils.ts                 # Utilities
└── routeTree.gen.ts             # Auto-generated by TanStack Router
```

## Setup

### 1. Install Dependencies

```bash
pnpm install
```

### 2. Configure Environment

Copy `.env.example` to `.env` and fill in your values:

```bash
# Supabase (get from supabase.com dashboard)
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Backend API
VITE_API_URL=http://localhost:3000
```

### 3. Start Development Server

```bash
pnpm dev
```

The app will be available at `http://localhost:5173`

### 4. Build for Production

```bash
pnpm build
```

## Development

### Route Generation

TanStack Router automatically generates the route tree when you:
- Add/modify/delete files in `src/routes/`
- Run `pnpm dev` or `pnpm build`

The generated `routeTree.gen.ts` file provides full type safety for navigation.

### Adding a New Route

1. Create a file in `src/routes/`:
```typescript
// src/routes/app/new-feature.tsx
import { createFileRoute } from '@tanstack/react-router'

export const Route = createFileRoute('/app/new-feature')({
  component: NewFeatureComponent,
})

function NewFeatureComponent() {
  return <div>New Feature</div>
}
```

2. Route is automatically registered and type-safe:
```typescript
navigate({ to: '/app/new-feature' }) // ✅ Type-safe!
```

### Using the API

```typescript
import { usePosts, useSchedulePost } from '@/lib/api/hooks'

function MyComponent() {
  // Fetch posts with caching
  const { data, isLoading } = usePosts(orgId)

  // Schedule a post with optimistic updates
  const scheduleMutation = useSchedulePost(orgId)

  const handleSubmit = async () => {
    await scheduleMutation.mutateAsync({
      content: 'Hello world!',
      scheduledFor: new Date().toISOString(),
    })
  }
}
```

### Real-time Updates

```typescript
import { useSSE } from '@/lib/sse/client'
import { useEventStore } from '@/lib/event-store/store'

function MyComponent() {
  const orgId = '...'

  // Subscribe to SSE events
  useSSE(orgId, (event) => {
    // Apply event to local store
    useEventStore.getState().applyEvent(event)
  })

  // Get posts from local store
  const posts = useEventStore(state =>
    Array.from(state.posts.values())
  )
}
```

### Optimistic Updates

```typescript
import { useEventStore } from '@/lib/event-store/store'
import { randomUUID } from '@/lib/utils'

// Create optimistic event
const optimisticId = randomUUID()
const optimisticEvent = { /* ... */ }

// Apply immediately
useEventStore.getState().applyOptimisticEvent(
  optimisticEvent,
  optimisticId
)

try {
  // Send to backend
  await api.schedulePost(...)

  // Backend will send confirmed event via SSE
} catch (error) {
  // Rollback on error
  useEventStore.getState().rollbackOptimisticEvent(optimisticId)
}
```

## Testing the App

### Without Backend

The app is designed to work gracefully without the backend:
- Auth will fail (expected - need Supabase setup)
- API calls will show loading states
- SSE won't connect (will show reconnecting in console)

### With Backend

1. Start the API server: `cd ../api && pnpm dev`
2. Start the web app: `pnpm dev`
3. Create a Supabase project and configure `.env`
4. Login with magic link
5. Create an organization
6. Schedule a post
7. Watch real-time updates in multiple browser tabs!

## Performance

### Code Splitting

Routes are automatically code-split by Vite:
- Landing page: ~140KB (gzipped: ~40KB)
- Each route loads on-demand
- Shared chunks are extracted automatically

### Caching Strategy

```typescript
// TanStack Query default config
{
  staleTime: 5 * 60 * 1000,  // 5 minutes
  retry: 1,                   // Retry failed requests once
}
```

- API responses cached in memory
- SSE events update cache in real-time
- Automatic cache invalidation on mutations

### Real-time Updates

- SSE connection per organization
- Exponential backoff on reconnection (1s → 30s max)
- Events applied immediately to local store
- Zero-latency UI updates

## Deployment

### Static Hosting (Netlify, Vercel, etc.)

```bash
pnpm build
# Upload dist/ folder
```

### Docker

```dockerfile
FROM node:20-alpine AS builder
WORKDIR /app
COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install
COPY . .
RUN pnpm build

FROM nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

### Environment Variables

Make sure to set production values:
- `VITE_SUPABASE_URL`: Your production Supabase URL
- `VITE_SUPABASE_ANON_KEY`: Your production Supabase anon key
- `VITE_API_URL`: Your production API URL

## Troubleshooting

### "Cannot find module" errors

Run `pnpm vite build --mode development` to regenerate the route tree.

### SSE not connecting

Check:
1. Backend API is running
2. `VITE_API_URL` is correct
3. CORS is configured on backend
4. Browser console for connection errors

### Optimistic updates not working

The SSE connection must be active. Check browser console for:
```
[SSE] Connected to event stream
```

If you see reconnection attempts, the backend may not be running.

### TypeScript errors after adding routes

The route tree is auto-generated. Run:
```bash
pnpm vite build --mode development
```

This will update `routeTree.gen.ts` with your new routes.

## Contributing

1. Create feature branch
2. Add/modify routes in `src/routes/`
3. Use existing API hooks when possible
4. Follow the optimistic update pattern for mutations
5. Test with and without backend running
6. Build succeeds: `pnpm build`
